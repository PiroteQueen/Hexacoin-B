# 登录鉴权流程说明

## 一、登录方式
系统提供两种登录方式：
1. 手机号+短信验证码登录（主要登录方式）
2. OAuth2 密码模式登录（后端接口，非前端使用）

## 二、短信验证码登录流程

### 1. 获取验证码
- 接口：`POST /request_sms_code`
- 流程：
  - 用户提供手机号
  - 系统生成4位数验证码
  - 在非生产环境下固定验证码为9999
  - 生产环境调用阿里云短信服务发送验证码
  - 将验证码记录保存到数据库

### 2. 验证码登录/注册
- 接口：`POST /signup_and_login_with_mobile_phone_and_sms_code`
- 流程：
  - 用户提供手机号和收到的验证码
  - 系统验证码有效性检查：
    - 验证码是否存在
    - 验证码是否正确
    - 验证码是否过期
  - 验证通过后：
    - 如果是新用户，自动创建用户账号
    - 如果是老用户，直接登录
    - 生成JWT访问令牌返回给客户端

## 三、Token生成与验证

### 1. Token生成
- 使用JWT（JSON Web Token）格式
- Token包含信息：
  - sub: 用户ID
  - exp: 过期时间
- Token配置：
  - 加密算法：HS256
  - 密钥：从系统配置读取SECRET_KEY
  - 有效期：从系统配置读取ACCESS_TOKEN_EXPIRE_MINUTES

### 2. Token验证
系统使用FastAPI的依赖注入机制进行Token验证：

1. 请求拦截
- 通过OAuth2PasswordBearer进行Token提取
- 从请求头Authorization字段获取Bearer Token

2. Token解析与验证
- 使用JWT解码Token
- 验证Token签名
- 检查Token是否过期
- 提取用户ID（sub字段）

3. 用户状态验证
- 根据用户ID查询用户信息
- 验证用户是否存在
- 验证用户是否处于活跃状态

## 四、权限控制

系统实现了两级权限控制：
1. 基础用户权限：需要有效的Token
2. 超级管理员权限：需要用户具有superuser标记

## 五、安全特性

1. 密码安全
- 使用bcrypt算法进行密码哈希
- 支持密码验证和哈希生成

2. Token安全
- 使用JWT标准
- 支持Token过期机制
- 每次请求都会验证Token有效性

3. 会话管理
- 使用数据库Session管理用户会话
- 支持会话自动提交和回滚
- 确保资源正确释放

## 六、使用示例

### 1. 前端调用流程
```
1. 调用/request_sms_code获取验证码
2. 使用手机号和验证码调用/signup_and_login_with_mobile_phone_and_sms_code登录
3. 获取返回的access_token
4. 后续请求在Header中携带Token: Bearer {access_token}
```

### 2. 接口鉴权使用
```python
# FastAPI路由中使用当前用户依赖
@router.get("/user/profile")
def get_profile(current_user: CurrentUser):
    return current_user

# 使用超级管理员依赖
@router.post("/admin/operation")
def admin_operation(current_user: CurrentSuperUser):
    return {"message": "管理员操作成功"}
``` 